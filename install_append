# -*- sh -*-
# Rename the Gold plugin elsewhere, as we're erasing *.so below
mv %{buildroot}/usr/lib64/LLVMgold.so %{buildroot}/usr/lib64/LLVMgold.so.save

# Remove files that should come from the main llvm package
rm -rf %{buildroot}/usr/include
rm -rf %{buildroot}/usr/lib64/*.a
rm -rf %{buildroot}/usr/lib64/*.so
rm -rf %{buildroot}/usr/lib64/cmake
rm -rf %{buildroot}/usr/lib64/pkgconfig
rm -rf %{buildroot}/usr/libexec

mv %{buildroot}/usr/share/package-licenses %{buildroot}/usr/
rm -rf %{buildroot}/usr/share/*
mv %{buildroot}/usr/package-licenses %{buildroot}/usr/share

# Rename the tools to have a versioned suffix and symlink back
pushd %{buildroot}/usr/bin
VERSION=%{version}
VERSION=${VERSION%%%%.*}
for f in *; do
    case "$f" in
        *-$VERSION)
            # Already versioned, leave it alone
            continue
            ;;
    esac
    if [ -L "$f" ]; then
        cf=$(readlink $f)
        case $cf in
            *-$VERSION)
                # symlink already points to versioned file
                continue
                ;;
            *)
                # Retarget the symlink
                ln -s -f $cf-$VERSION $f
                ;;
        esac
    fi
    mv $f $f-$VERSION
    ln -s -f $f-$VERSION $f
done
popd

# Ditto for the gold plugin
pushd %{buildroot}/usr/lib64
mv LLVMgold.so LLVMgold-$VERSION.so
ln -s LLVMgold-$VERSION.so LLVMgold.so
mkdir -p ../lib/bfd-plugins
ln -s ../../lib64/LLVMgold-$VERSION.so ../lib/bfd-plugins
popd
